<html>

  <head>
    <title>jQuery Mobile page</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="stylesheet" href="https://web.sfc.keio.ac.jp/~slash/ABC/ac/themes/TOBASIC.css" />
    <link rel="stylesheet" href="https://web.sfc.keio.ac.jp/~slash/ABC/ac/themes/jquery.mobile.icons.min.css" />

    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script> 
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile.structure-1.4.5.min.css" /> 
  </head>
  
  <body>
    <h1 style="text-align: center; color: #1976d2;">📱 Activity Recognition Data Collection</h1>
    
    <h2>🔧 Step 0: Test / テスト機能（先に必ずチェック！）</h2>
    <div style="background-color: #fff3e0; padding: 15px; margin: 10px 0; border: 3px solid #ff9800; border-radius: 10px;">
      <h3 style="color: #ff6f00; margin-top: 0;">⚠️ データ収集前に必ずテスト！</h3>
      
      <div style="margin: 15px 0; padding: 10px; background-color: white; border-radius: 5px;">
        <h4>📱 センサー権限状態 / Sensor Permission Status</h4>
        <p>状態 / Status: <span id="permission_status" style="font-weight: bold; font-size: 1.3em; color: red;">未確認 / Not Checked</span></p>
        <button onclick="checkPermission()" style="padding: 10px 20px; margin: 5px; font-size: 1.1em; background-color: #2196F3; color: white; border: none; cursor: pointer; border-radius: 5px;">🔍 権限確認 / Check Permission</button>
      </div>
      
      <div style="margin: 15px 0; padding: 10px; background-color: white; border-radius: 5px;">
        <h4>🎵 音声テスト / Audio Test</h4>
        <p>音が鳴るか確認 / Check if sound plays</p>
        <button onclick="testSound()" style="padding: 10px 20px; margin: 5px; font-size: 1.1em; background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 5px;">🔊 音テスト / Test Sound</button>
        <p>結果 / Result: <span id="sound_test_result" style="font-weight: bold;">--</span></p>
      </div>
      
      <div style="margin: 15px 0; padding: 10px; background-color: white; border-radius: 5px;">
        <h4>📊 センサーテスト / Sensor Test</h4>
        <p>加速度センサーが動作するか5秒間テスト / Test sensor for 5 seconds</p>
        <button onclick="testSensor()" style="padding: 10px 20px; margin: 5px; font-size: 1.1em; background-color: #9C27B0; color: white; border: none; cursor: pointer; border-radius: 5px;">📡 センサーテスト / Test Sensor</button>
        <p>データ数 / Data count: <span id="test_data_count" style="font-weight: bold; font-size: 1.2em; color: green;">0</span></p>
        <p>最新データ / Latest: X=<span id="test_x">--</span>, Y=<span id="test_y">--</span>, Z=<span id="test_z">--</span></p>
      </div>
      
      <div style="margin: 15px 0; padding: 15px; background-color: #ffebee; border-radius: 5px; border: 2px solid #f44336;">
        <p style="margin: 5px 0; font-weight: bold;">✅ 全てのテストがOKなら、下に進んでください</p>
        <p style="margin: 5px 0; font-weight: bold;">❌ NGの場合は、ブラウザ設定で「モーションとセンサー」を許可してください</p>
      </div>
    </div>
    
    <h2>Step 1: Select Activity / 行動を選択</h2>
    <div style="background-color: #f0f0f0; padding: 15px; margin: 10px 0;">
      <div style="margin: 10px 0;">
        <button onclick="setLabel('still')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #e3f2fd;">Still / 静止</button>
        <button onclick="setLabel('tuugaku_walk')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #fff3e0;">通学歩き</button>
        <button onclick="setLabel('sanpo')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #e8f5e9;">散歩</button>
        <button onclick="setLabel('yotsunbai')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #fce4ec;">四足歩行</button>
        <button onclick="setLabel('heel_walk')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #f3e5f5;">ヒール歩き</button>
        <button onclick="setLabel('sandal_walk')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #ffccbc;">サンダル歩き</button>
        <button onclick="setLabel('stairs')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #ffe0b2;">階段</button>
      </div>
      <p style="text-align: center;">Current Label / 現在のラベル: <span id="current_label" style="color: blue; font-weight: bold; font-size: 1.8em;">none</span></p>
    </div>
      
    <h2>Step 2: Start Collection / データ収集開始</h2>
    <div style="margin: 15px 0; padding: 20px; background-color: #fff9c4; border-radius: 10px; text-align: center;">
      <p style="font-size: 1.1em; margin-bottom: 15px;">👇 このボタン1つで全て自動！<br>（センサー許可 → <strong>3秒準備</strong> → <strong>2分間収集</strong> → 自動停止）</p>
      <button onclick="start30SecondCollection()" style="padding: 20px 40px; margin: 10px; font-size: 1.5em; background-color: #2196F3; color: white; border: none; cursor: pointer; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">⏱️ 2分間データ収集開始<br>Start 2min Collection<br><small style="font-size: 0.6em;">（3秒準備 + 120秒収集）</small></button>
      <p style="margin-top: 15px;"><span id="status_display" style="color: orange; font-weight: bold; font-size: 1.3em;">準備中 / Preparing</span></p>
      <p style="margin-top: 5px;">残り時間 / Time Remaining: <span id="timer_display" style="color: red; font-weight: bold; font-size: 2.5em;">--</span> 秒</p>
    </div>
    
    <h2>Step 3: Download / データダウンロード</h2>
    <div style="background-color: #f0f0f0; padding: 15px; margin: 10px 0; text-align: center;">
      <p>収集データ数 / Collected Data Points: <span id="data_count" style="color: green; font-weight: bold; font-size: 1.8em;">0</span></p>
      <button onclick="downloadCSV()" style="padding: 15px 30px; margin: 10px; font-size: 1.3em; background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 5px;">📥 Download CSV / CSVダウンロード</button>
      <button onclick="clearCollectedData()" style="padding: 15px 30px; margin: 10px; font-size: 1.3em; background-color: #f44336; color: white; border: none; cursor: pointer; border-radius: 5px;">🗑️ Clear Data / データクリア</button>
    </div>
    
    <hr style="margin: 30px 0;"/>
    
    <h2>Activity Recognition</h2>
    <h3>(3) Classification result</h3>
    <ul>
    <li> Result: <span id="current_result" style="color:red;font-size:2.0em; font-weight: bold; border-top: 1px solid black; border-bottom: 1px solid black;">null</span> </li> 
    </ul>
    
    <h3>(2) Features for this time window</h3>
    <ul>
    <li> min x: <span id="xmin">0</span> </li>
    <li> max x: <span id="xmax">0</span> </li>
    <li> ave x: <span id="xave">0</span> </li>

    <li> min y: <span id="ymin">0</span> </li>
    <li> max y: <span id="ymax">0</span> </li>
    <li> ave y: <span id="yave">0</span> </li>

    <li> min z: <span id="zmin">0</span> </li>
    <li> max z: <span id="zmax">0</span> </li>
    <li> ave z: <span id="zave">0</span> </li>
    </ul>

    <h3>(1) Raw sensor values for this time window</h3>
    <ul>
    <li> X: <span id="accel-x">0</span> </li> 
    <li> Y: <span id="accel-y">0</span> </li> 
    <li> Z: <span id="accel-z">0</span> </li>
    </ul>
    
    <textarea id="raw-data" style="width:90%;height:50vh;"></textarea>

    <hr/>

    <h2>レポート記述欄 / Report</h2>
    <ul>
      <li>Name / 氏名:</li>
      <li>Department / 学部:</li>
      <li>Year / 学年:</li>
      <li>Student ID / 学籍番号:</li>
      <li>CNS Email / CNSメールアドレス:</li>
    </ul>

    <h3>Collected Data / 収集した行動データ</h3>
    <ul>
      <li>Reason behind data selection / 選定した理由</li>
      <li>Details about collection / 収集についての詳細</li>
      <li>Any challenges and tweaks / 工夫した点・困難だった点</li>
    </ul>

    <h3>Features / 特徴量</h3>
    <ul>
      <li>Reason behind data selection / 選定した理由</li>
      <li>Details about additional feature types / 追加した特徴量について</li>
      <li>Any challenges and tweaks / 工夫した点・困難だった点</li>
    </ul>    

    <h3>ML Model / 機械学習モデル</h3>
    <ul>
      <li>Algorithm you used and the training result / 採用したアルゴリズムや学習結果の詳細</li>
      <li>Any challenges and tweaks / 工夫した点・困難だった点</li>
    </ul>

    <h3>Real-time execution result / 実機に移植しての性能評価</h3>
    <ul>
      <li>Evaluation metric you used / 評価尺度について</li>
      <li>Evaluation results / 評価結果</li>
      <li>Any challenges and tweaks / 工夫した点・困難だった点</li>
    </ul>

  </body>


<!--  ===========================================  -->
<script type="text/javascript">

alert("Welcome to example Activity Recognition (11).");

//CONFIG: Length of each time window
const NUM_DATA_PER_FRAME = 200;

//Arrays for saving the raw sensor data
var xdata = [];
var ydata = [];
var zdata = [];
var num_data = 0;

//Features
var xmin = 0.0;
var xmax = 0.0;
var xave = 0.0;
var ymin = 0.0;
var ymax = 0.0;
var yave = 0.0;
var zmin = 0.0;
var zmax = 0.0;
var zave = 0.0;

//Data collection variables
var collectedData = []; // Array to store all collected data with labels
var currentLabel = 'none'; // Current activity label

//Timer variables
var timerInterval = null; // Timer interval ID
var remainingTime = 0; // Remaining time in seconds
var isCollecting = false; // Flag to track if collection is active

//Test variables
var testDataCount = 0; // Counter for test data
var testInterval = null; // Test timer interval

//Audio context (create once and reuse)
var audioContext = null;

// Initialize audio context on first user interaction
function initAudioContext(){
    if(!audioContext && (window.AudioContext || window.webkitAudioContext)){
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            // Resume context for iOS Safari
            if(audioContext.state === 'suspended'){
                audioContext.resume();
            }
            console.log('AudioContext initialized');
        } catch(e) {
            console.log('AudioContext init failed:', e);
        }
    }
    return audioContext;
}

//////////////////////////////////////////////////////
//Function to get sensor access permission from the browser
//////////////////////////////////////////////////////
function requestMotionPermission(){
  if ( DeviceMotionEvent &&
       typeof DeviceMotionEvent.requestPermission === 'function' ){
      // iOS 13+ の Safari
      // 許可を取得
      DeviceMotionEvent.requestPermission().then(permissionState => {
	  if (permissionState === 'granted') {
              // 許可を得られた場合、devicemotionをイベントリスナーに追加
	      window.addEventListener("devicemotion", handleAcceleration, false);
	  } else {
              // 許可を得られなかった場合の処理
	      console.log("Perrmission not granted!");
	      alert("Perrmission not granted!");
	  }
      }).catch(console.error) // https通信でない場合などで許可を取得できなかった場合

  } else {
      //For other devices
      console.log("detected other device. so adding listener...");
      window.addEventListener("devicemotion", handleAcceleration, false);
  }

}

function stopDeviceMotion(){ 
    window.removeEventListener("devicemotion", handleAcceleration, false);
}


////////////////////////////////////////////////////////////////////
//Function(1): 読み込まれてきた最新の加速度データ(X,Y,Z)を処理する関数
//  - この関数は(機種によりますが) 秒速10〜100回というような高頻度で呼ばれます
////////////////////////////////////////////////////////////////////
function handleAcceleration(ev){

    //alert("" + event.acceleration.x + " " + event.acceleration.y + " " + event.acceleration.z);
    $('#accel-x').text( ev.acceleration.x );
    xdata.push(ev.acceleration.x);
    $('#accel-y').text( ev.acceleration.y );
    ydata.push(ev.acceleration.y);
    $('#accel-z').text( ev.acceleration.z );
    zdata.push(ev.acceleration.z);
    $('#raw-data').append(ev.acceleration.x + ", " + ev.acceleration.y + ", " + ev.acceleration.z + "\n");

    // Save data with label and timestamp
    var timestamp = new Date().getTime();
    collectedData.push({
        timestamp: timestamp,
        x: ev.acceleration.x,
        y: ev.acceleration.y,
        z: ev.acceleration.z,
        label: currentLabel
    });
    $('#data_count').text(collectedData.length);

    num_data++;
    //If we have enough raw sensor data...
    if( num_data == NUM_DATA_PER_FRAME ){

	//execute feature calculations.
	featureExtraction();

	//Let's classify the activity!
	var current_activity = classify();
	$('#current_result').text( current_activity );
	
	//clear the raw sensor data
	xdata=[];
	ydata=[];
	zdata=[];
	//Clear the textarea 
	$('#raw-data').empty();
	//Counter back to 0
	num_data=0;
    }
    
}

////////////////////////////////////////////////////////////////////
//Function(2):センサデータから "feature"(特徴量)を計算する関数
//  - この関数は NUM_DATA_PER_FRAME 変数で設定された数だけセンサデータが
//    「設定されたタイムフレーム」にたまる度に呼ばれます。
//  - 例: センサデータが 50Hz (=50 data / seconds)
//        NUM_DATA_PER_FRAME が 200 の場合
//        → 約4秒に1度の頻度で呼ばれます
////////////////////////////////////////////////////////////////////
//helper func. to calculate average
const arrAvg = arr => arr.reduce((a,b) => a + b, 0) / arr.length

function featureExtraction(){
    xmin = Math.min.apply(Math, xdata); $('#xmin').text(xmin);
    xmax = Math.max.apply(Math, xdata); $('#xmax').text(xmax);
    xave = arrAvg(xdata); $('#xave').text(xave);
    
    ymin = Math.min.apply(Math, ydata); $('#ymin').text(ymin);
    ymax = Math.max.apply(Math, ydata); $('#ymax').text(ymax);
    yave = arrAvg(ydata); $('#yave').text(yave);

    zmax = Math.max.apply(Math, zdata); $('#zmax').text(zmax);
    zmin = Math.min.apply(Math, zdata); $('#zmin').text(zmin);
    zave = arrAvg(zdata); $('#zave').text(zave);
}

////////////////////////////////////////////////////////////////////
//Function(3): 最新フレームにおける特徴量(feature)から、現在のユーザの
//行動を分類 (classify) する関数          
//  - ここに書いてあるのは、手打ちで書いたサンプルのif文ロジックです
//  - 実際には機械学習エンジンが出力したif文の固まり (決定木アルゴリズムの場合)
//  - がここに入ります
////////////////////////////////////////////////////////////////////
function classify(){

    if(xmax > 1){
	return 'walking';
    }else{
	return 'still';
    }

    /*
    if(zmin <= 0.1){
	if(xmin <= -0.2){
	    if(xmin <= -0.4){
		return 'walking';
	    }else{
		return 'still';
	    }
	}else{
	    return 'walking';
	}
    }else{
	return 'still';
    }
    */

}

////////////////////////////////////////////////////////////////////
//Test Functions / テスト機能
////////////////////////////////////////////////////////////////////

// Check sensor permission
function checkPermission(){
    $('#permission_status').text('確認中... / Checking...').css('color', 'orange');
    
    if ( DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function' ){
        // iOS 13+ の Safari
        DeviceMotionEvent.requestPermission().then(permissionState => {
            if (permissionState === 'granted') {
                $('#permission_status').text('✅ 許可済み / Granted').css('color', 'green');
                alert('✅ センサー権限OK！/ Sensor permission granted!');
            } else {
                $('#permission_status').text('❌ 拒否 / Denied').css('color', 'red');
                alert('❌ センサー権限が拒否されました。ブラウザ設定を確認してください。\n\nSensor permission denied. Please check browser settings.');
            }
        }).catch(function(error){
            $('#permission_status').text('❌ エラー / Error: ' + error).css('color', 'red');
            alert('❌ エラー: ' + error);
        });
    } else {
        // For other devices (Android, etc.)
        $('#permission_status').text('✅ 権限不要（Android等） / Permission not required').css('color', 'green');
        alert('✅ このデバイスは権限確認不要です（Android等）\n\nPermission check not required for this device.');
    }
}

// Test sound
function testSound(){
    $('#sound_test_result').text('テスト中... / Testing...').css('color', 'orange');
    
    if (window.AudioContext || window.webkitAudioContext) {
        try {
            // Initialize audio context on user click
            var ctx = initAudioContext();
            
            if(!ctx){
                $('#sound_test_result').text('❌ AudioContext失敗 / Failed').css('color', 'red');
                alert('❌ AudioContextの初期化に失敗しました');
                return;
            }
            
            // Resume if needed (critical for iOS)
            if(ctx.state === 'suspended'){
                ctx.resume().then(function(){
                    console.log('AudioContext resumed');
                });
            }
            
            // Play 3 different beeps
            playBeep(440, 200);
            setTimeout(function(){ playBeep(660, 200); }, 300);
            setTimeout(function(){ playBeep(880, 200); }, 600);
            
            $('#sound_test_result').text('✅ OK - 音を再生しました / Sound played').css('color', 'green');
            setTimeout(function(){
                alert('✅ 音声テスト完了！\n\n3つのビープ音（低→中→高）が聞こえましたか？\n聞こえなかった場合:\n・音量を上げる\n・マナーモード解除\n・ブラウザを変える（Chrome推奨）\n\nAudio test OK! Did you hear 3 beeps?');
            }, 1000);
        } catch(e) {
            $('#sound_test_result').text('❌ エラー / Error: ' + e.message).css('color', 'red');
            alert('❌ 音声エラー: ' + e.message);
        }
    } else {
        $('#sound_test_result').text('❌ 非対応 / Not supported').css('color', 'red');
        alert('❌ このブラウザは音声をサポートしていません\n\nAudio not supported in this browser');
    }
}

// Test sensor for 5 seconds
function testSensor(){
    if(testInterval){
        alert('テスト実行中です / Test already running');
        return;
    }
    
    testDataCount = 0;
    $('#test_data_count').text('0');
    $('#test_x').text('--');
    $('#test_y').text('--');
    $('#test_z').text('--');
    
    alert('5秒間センサーテストを開始します！\nスマホを動かしてみてください。\n\n5-second sensor test starting!\nPlease move your phone.');
    
    // Handler for test
    function handleTestAcceleration(ev){
        testDataCount++;
        $('#test_data_count').text(testDataCount);
        $('#test_x').text(ev.acceleration.x.toFixed(3));
        $('#test_y').text(ev.acceleration.y.toFixed(3));
        $('#test_z').text(ev.acceleration.z.toFixed(3));
    }
    
    // Request permission and start test
    if ( DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function' ){
        // iOS 13+ の Safari
        DeviceMotionEvent.requestPermission().then(permissionState => {
            if (permissionState === 'granted') {
                window.addEventListener("devicemotion", handleTestAcceleration, false);
                
                // Stop after 5 seconds
                testInterval = setTimeout(function(){
                    window.removeEventListener("devicemotion", handleTestAcceleration, false);
                    testInterval = null;
                    
                    if(testDataCount > 0){
                        alert('✅ センサーテストOK！\n' + testDataCount + ' 個のデータを取得しました。\n\n✅ Sensor test OK!\nCollected ' + testDataCount + ' data points.');
                    } else {
                        alert('❌ センサーからデータが取得できませんでした。\nブラウザ設定を確認してください。\n\n❌ No sensor data received.\nPlease check browser settings.');
                    }
                }, 5000);
            } else {
                alert('❌ センサー権限が拒否されました\n\n❌ Sensor permission denied');
            }
        }).catch(function(error){
            alert('❌ エラー: ' + error);
        });
    } else {
        // For other devices
        window.addEventListener("devicemotion", handleTestAcceleration, false);
        
        // Stop after 5 seconds
        testInterval = setTimeout(function(){
            window.removeEventListener("devicemotion", handleTestAcceleration, false);
            testInterval = null;
            
            if(testDataCount > 0){
                alert('✅ センサーテストOK！\n' + testDataCount + ' 個のデータを取得しました。\n\n✅ Sensor test OK!\nCollected ' + testDataCount + ' data points.');
            } else {
                alert('❌ センサーからデータが取得できませんでした。\n\n❌ No sensor data received.');
            }
        }, 5000);
    }
}

////////////////////////////////////////////////////////////////////
//Data Collection Functions / データ収集用の関数
////////////////////////////////////////////////////////////////////

// Set the current activity label
function setLabel(label){
    currentLabel = label;
    $('#current_label').text(label);
    alert('Label set to: ' + label + ' / ラベルを設定しました: ' + label);
}

// Download collected data as CSV
function downloadCSV(){
    if(collectedData.length === 0){
        alert('No data to download! / ダウンロードするデータがありません！');
        return;
    }
    
    // Create CSV header
    var csv = 'timestamp,x,y,z,label\n';
    
    // Add data rows
    for(var i = 0; i < collectedData.length; i++){
        var row = collectedData[i];
        csv += row.timestamp + ',' + 
               row.x + ',' + 
               row.y + ',' + 
               row.z + ',' + 
               row.label + '\n';
    }
    
    // Create download link
    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    var link = document.createElement('a');
    var url = URL.createObjectURL(blob);
    
    // Generate filename with timestamp
    var now = new Date();
    var filename = 'activity_data_' + 
                   now.getFullYear() + 
                   ('0' + (now.getMonth() + 1)).slice(-2) + 
                   ('0' + now.getDate()).slice(-2) + '_' +
                   ('0' + now.getHours()).slice(-2) + 
                   ('0' + now.getMinutes()).slice(-2) + 
                   ('0' + now.getSeconds()).slice(-2) + 
                   '.csv';
    
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert('Downloaded ' + collectedData.length + ' data points as ' + filename + 
          ' / ' + collectedData.length + ' 個のデータを ' + filename + ' としてダウンロードしました');
}

// Clear all collected data
function clearCollectedData(){
    if(confirm('Are you sure you want to clear all collected data? / 収集したデータを全てクリアしますか？')){
        collectedData = [];
        $('#data_count').text('0');
        alert('All data cleared! / 全てのデータをクリアしました！');
    }
}

////////////////////////////////////////////////////////////////////
//2-Minute Timer Functions / 2分間タイマー機能（3秒準備 + 120秒収集）
////////////////////////////////////////////////////////////////////

// Start 2-minute data collection with 3-second preparation
function start30SecondCollection(){
    // Check if label is set
    if(currentLabel === 'none'){
        alert('Please select an activity label first! / 先に行動ラベルを選択してください！');
        return;
    }
    
    // Check if already collecting
    if(isCollecting){
        alert('Collection already in progress! / 既に収集中です！');
        return;
    }
    
    // Initialize audio context on user click (important!)
    initAudioContext();
    
    alert('3秒後にデータ収集を開始します！スマホをポケットに入れてください。\n\nData collection will start in 3 seconds! Put your phone in your pocket.');
    
    // Start timer immediately (will show 3-second preparation)
    startTimer();
    
    // Start motion sensing after 3 seconds
    setTimeout(function(){
        if ( DeviceMotionEvent &&
             typeof DeviceMotionEvent.requestPermission === 'function' ){
            // iOS 13+ の Safari
            DeviceMotionEvent.requestPermission().then(permissionState => {
                if (permissionState === 'granted') {
                    window.addEventListener("devicemotion", handleAcceleration, false);
                } else {
                    alert("Permission not granted! / 許可されませんでした！");
                    stopTimer();
                }
            }).catch(function(error){
                console.error(error);
                stopTimer();
            });
        } else {
            // For other devices
            window.addEventListener("devicemotion", handleAcceleration, false);
        }
    }, 3000); // Wait 3 seconds before starting sensor
}

// Start the timer
function startTimer(){
    isCollecting = true;
    remainingTime = 123; // 3 seconds preparation + 120 seconds collection
    
    // Show "準備中" initially
    $('#status_display').text('準備中 / Preparing').css('color', 'orange');
    $('#timer_display').text('3').css('color', 'orange');
    
    // Beep sound at start
    if (window.AudioContext || window.webkitAudioContext) {
        playBeep(440, 200); // 440Hz for 200ms
    }
    
    // Update timer every second
    timerInterval = setInterval(function(){
        remainingTime--;
        
        // First 3 seconds: Preparation phase
        if(remainingTime > 120){
            var prepTime = remainingTime - 120;
            $('#timer_display').text(prepTime).css('color', 'orange');
            $('#status_display').text('準備中 / Preparing').css('color', 'orange');
            
            // Beep during preparation countdown
            if (window.AudioContext || window.webkitAudioContext) {
                playBeep(660, 100);
            }
        }
        // Collection phase (120 seconds)
        else if(remainingTime === 120){
            // Start of data collection
            $('#status_display').text('収集中 / Collecting').css('color', 'green');
            $('#timer_display').text(remainingTime).css('color', 'red');
            
            // Double beep to signal start of actual collection
            if (window.AudioContext || window.webkitAudioContext) {
                playBeep(880, 150);
                setTimeout(function(){ playBeep(880, 150); }, 200);
            }
        }
        else if(remainingTime > 0){
            // Normal collection countdown
            $('#timer_display').text(remainingTime).css('color', 'red');
            
            // Beep at 60, 30, 10, 5, 3, 2, 1 seconds remaining
            if(remainingTime === 60 || remainingTime === 30 || remainingTime === 10 || 
               remainingTime === 5 || (remainingTime <= 3 && remainingTime > 0)){
                if (window.AudioContext || window.webkitAudioContext) {
                    playBeep(880, 100); // Higher pitch beep
                }
            }
        }
        else{
            // Time is up
            stopTimer();
        }
    }, 1000);
}

// Stop the timer and collection
function stopTimer(){
    if(timerInterval){
        clearInterval(timerInterval);
        timerInterval = null;
    }
    
    isCollecting = false;
    remainingTime = 0;
    $('#timer_display').text('--').css('color', 'red');
    $('#status_display').text('完了 / Completed').css('color', 'blue');
    
    // Stop motion sensing
    window.removeEventListener("devicemotion", handleAcceleration, false);
    
    // Final beep (lower pitch, longer duration)
    if (window.AudioContext || window.webkitAudioContext) {
        playBeep(220, 500);
    }
    
    alert('2分間のデータ収集が完了しました！/ 2-minute collection completed!\n\n収集データ数 / Data points: ' + collectedData.length);
}

// Play beep sound (improved version)
function playBeep(frequency, duration){
    try {
        // Initialize audio context if not already done
        var ctx = initAudioContext();
        
        if(!ctx){
            console.log('AudioContext not available');
            return;
        }
        
        // Resume if suspended (important for iOS)
        if(ctx.state === 'suspended'){
            ctx.resume().then(function(){
                playBeepInternal(ctx, frequency, duration);
            });
        } else {
            playBeepInternal(ctx, frequency, duration);
        }
    } catch(e) {
        console.log('Audio error:', e);
    }
}

// Internal beep function
function playBeepInternal(ctx, frequency, duration){
    try {
        var oscillator = ctx.createOscillator();
        var gainNode = ctx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration/1000);
        
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + duration/1000);
    } catch(e) {
        console.log('Beep error:', e);
    }
}

</script>
<!--  ===========================================  -->


</html>
