<html>

  <head>
    <title>jQuery Mobile page</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="stylesheet" href="https://web.sfc.keio.ac.jp/~slash/ABC/ac/themes/TOBASIC.css" />
    <link rel="stylesheet" href="https://web.sfc.keio.ac.jp/~slash/ABC/ac/themes/jquery.mobile.icons.min.css" />

    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script> 
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile.structure-1.4.5.min.css" /> 
  </head>
  
  <body>
    <h1 style="text-align: center; color: #1976d2;">ğŸ“± Activity Recognition Data Collection</h1>
    
    <h2>Step 1: Select Activity / è¡Œå‹•ã‚’é¸æŠ</h2>
    <div style="background-color: #f0f0f0; padding: 15px; margin: 10px 0;">
      <div style="margin: 10px 0;">
        <button onclick="setLabel('still')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #e3f2fd;">Still / é™æ­¢</button>
        <button onclick="setLabel('tuugaku_walk')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #fff3e0;">é€šå­¦æ­©ã</button>
        <button onclick="setLabel('sanpo')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #e8f5e9;">æ•£æ­©</button>
        <button onclick="setLabel('yotsunbai')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #fce4ec;">å››è¶³æ­©è¡Œ</button>
        <button onclick="setLabel('heel_walk')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #f3e5f5;">ãƒ’ãƒ¼ãƒ«æ­©ã</button>
        <button onclick="setLabel('sandal_walk')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #ffccbc;">ã‚µãƒ³ãƒ€ãƒ«æ­©ã</button>
        <button onclick="setLabel('stairs')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #ffe0b2;">éšæ®µ</button>
      </div>
      <p style="text-align: center;">Current Label / ç¾åœ¨ã®ãƒ©ãƒ™ãƒ«: <span id="current_label" style="color: blue; font-weight: bold; font-size: 1.8em;">none</span></p>
    </div>
      
    <h2>Step 2: Start Collection / ãƒ‡ãƒ¼ã‚¿åé›†é–‹å§‹</h2>
    <div style="margin: 15px 0; padding: 20px; background-color: #fff9c4; border-radius: 10px; text-align: center;">
      <p style="font-size: 1.1em; margin-bottom: 15px;">ğŸ‘‡ ã“ã®ãƒœã‚¿ãƒ³1ã¤ã§å…¨ã¦è‡ªå‹•ï¼<br>ï¼ˆã‚»ãƒ³ã‚µãƒ¼è¨±å¯ â†’ <strong>3ç§’æº–å‚™</strong> â†’ <strong>2åˆ†é–“åé›†</strong> â†’ è‡ªå‹•åœæ­¢ï¼‰</p>
      <button onclick="start30SecondCollection()" style="padding: 20px 40px; margin: 10px; font-size: 1.5em; background-color: #2196F3; color: white; border: none; cursor: pointer; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">â±ï¸ 2åˆ†é–“ãƒ‡ãƒ¼ã‚¿åé›†é–‹å§‹<br>Start 2min Collection<br><small style="font-size: 0.6em;">ï¼ˆ3ç§’æº–å‚™ + 120ç§’åé›†ï¼‰</small></button>
      <p style="margin-top: 15px;"><span id="status_display" style="color: orange; font-weight: bold; font-size: 1.3em;">æº–å‚™ä¸­ / Preparing</span></p>
      <p style="margin-top: 5px;">æ®‹ã‚Šæ™‚é–“ / Time Remaining: <span id="timer_display" style="color: red; font-weight: bold; font-size: 2.5em;">--</span> ç§’</p>
    </div>
    
    <h2>Step 3: Download / ãƒ‡ãƒ¼ã‚¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h2>
    <div style="background-color: #f0f0f0; padding: 15px; margin: 10px 0; text-align: center;">
      <p>åé›†ãƒ‡ãƒ¼ã‚¿æ•° / Collected Data Points: <span id="data_count" style="color: green; font-weight: bold; font-size: 1.8em;">0</span></p>
      <button onclick="downloadCSV()" style="padding: 15px 30px; margin: 10px; font-size: 1.3em; background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 5px;">ğŸ“¥ Download CSV / CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button onclick="clearCollectedData()" style="padding: 15px 30px; margin: 10px; font-size: 1.3em; background-color: #f44336; color: white; border: none; cursor: pointer; border-radius: 5px;">ğŸ—‘ï¸ Clear Data / ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
    </div>
    
    <hr style="margin: 30px 0;"/>
    
    <h2>Activity Recognition</h2>
    <h3>(3) Classification result</h3>
    <ul>
    <li> Result: <span id="current_result" style="color:red;font-size:2.0em; font-weight: bold; border-top: 1px solid black; border-bottom: 1px solid black;">null</span> </li> 
    </ul>
    
    <h3>(2) Features for this time window</h3>
    <ul>
    <li> min x: <span id="xmin">0</span> </li>
    <li> max x: <span id="xmax">0</span> </li>
    <li> ave x: <span id="xave">0</span> </li>

    <li> min y: <span id="ymin">0</span> </li>
    <li> max y: <span id="ymax">0</span> </li>
    <li> ave y: <span id="yave">0</span> </li>

    <li> min z: <span id="zmin">0</span> </li>
    <li> max z: <span id="zmax">0</span> </li>
    <li> ave z: <span id="zave">0</span> </li>
    </ul>

    <h3>(1) Raw sensor values for this time window</h3>
    <ul>
    <li> X: <span id="accel-x">0</span> </li> 
    <li> Y: <span id="accel-y">0</span> </li> 
    <li> Z: <span id="accel-z">0</span> </li>
    </ul>
    
    <textarea id="raw-data" style="width:90%;height:50vh;"></textarea>

    <hr/>

    <h2>ãƒ¬ãƒãƒ¼ãƒˆè¨˜è¿°æ¬„ / Report</h2>
    <ul>
      <li>Name / æ°å:</li>
      <li>Department / å­¦éƒ¨:</li>
      <li>Year / å­¦å¹´:</li>
      <li>Student ID / å­¦ç±ç•ªå·:</li>
      <li>CNS Email / CNSãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</li>
    </ul>

    <h3>Collected Data / åé›†ã—ãŸè¡Œå‹•ãƒ‡ãƒ¼ã‚¿</h3>
    <ul>
      <li>Reason behind data selection / é¸å®šã—ãŸç†ç”±</li>
      <li>Details about collection / åé›†ã«ã¤ã„ã¦ã®è©³ç´°</li>
      <li>Any challenges and tweaks / å·¥å¤«ã—ãŸç‚¹ãƒ»å›°é›£ã ã£ãŸç‚¹</li>
    </ul>

    <h3>Features / ç‰¹å¾´é‡</h3>
    <ul>
      <li>Reason behind data selection / é¸å®šã—ãŸç†ç”±</li>
      <li>Details about additional feature types / è¿½åŠ ã—ãŸç‰¹å¾´é‡ã«ã¤ã„ã¦</li>
      <li>Any challenges and tweaks / å·¥å¤«ã—ãŸç‚¹ãƒ»å›°é›£ã ã£ãŸç‚¹</li>
    </ul>    

    <h3>ML Model / æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«</h3>
    <ul>
      <li>Algorithm you used and the training result / æ¡ç”¨ã—ãŸã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚„å­¦ç¿’çµæœã®è©³ç´°</li>
      <li>Any challenges and tweaks / å·¥å¤«ã—ãŸç‚¹ãƒ»å›°é›£ã ã£ãŸç‚¹</li>
    </ul>

    <h3>Real-time execution result / å®Ÿæ©Ÿã«ç§»æ¤ã—ã¦ã®æ€§èƒ½è©•ä¾¡</h3>
    <ul>
      <li>Evaluation metric you used / è©•ä¾¡å°ºåº¦ã«ã¤ã„ã¦</li>
      <li>Evaluation results / è©•ä¾¡çµæœ</li>
      <li>Any challenges and tweaks / å·¥å¤«ã—ãŸç‚¹ãƒ»å›°é›£ã ã£ãŸç‚¹</li>
    </ul>

  </body>


<!--  ===========================================  -->
<script type="text/javascript">

alert("Welcome to example Activity Recognition (11).");

//CONFIG: Length of each time window
const NUM_DATA_PER_FRAME = 200;

//Arrays for saving the raw sensor data
var xdata = [];
var ydata = [];
var zdata = [];
var num_data = 0;

//Features
var xmin = 0.0;
var xmax = 0.0;
var xave = 0.0;
var ymin = 0.0;
var ymax = 0.0;
var yave = 0.0;
var zmin = 0.0;
var zmax = 0.0;
var zave = 0.0;

//Data collection variables
var collectedData = []; // Array to store all collected data with labels
var currentLabel = 'none'; // Current activity label

//Timer variables
var timerInterval = null; // Timer interval ID
var remainingTime = 0; // Remaining time in seconds
var isCollecting = false; // Flag to track if collection is active

//////////////////////////////////////////////////////
//Function to get sensor access permission from the browser
//////////////////////////////////////////////////////
function requestMotionPermission(){
  if ( DeviceMotionEvent &&
       typeof DeviceMotionEvent.requestPermission === 'function' ){
      // iOS 13+ ã® Safari
      // è¨±å¯ã‚’å–å¾—
      DeviceMotionEvent.requestPermission().then(permissionState => {
	  if (permissionState === 'granted') {
              // è¨±å¯ã‚’å¾—ã‚‰ã‚ŒãŸå ´åˆã€devicemotionã‚’ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã«è¿½åŠ 
	      window.addEventListener("devicemotion", handleAcceleration, false);
	  } else {
              // è¨±å¯ã‚’å¾—ã‚‰ã‚Œãªã‹ã£ãŸå ´åˆã®å‡¦ç†
	      console.log("Perrmission not granted!");
	      alert("Perrmission not granted!");
	  }
      }).catch(console.error) // httpsé€šä¿¡ã§ãªã„å ´åˆãªã©ã§è¨±å¯ã‚’å–å¾—ã§ããªã‹ã£ãŸå ´åˆ

  } else {
      //For other devices
      console.log("detected other device. so adding listener...");
      window.addEventListener("devicemotion", handleAcceleration, false);
  }

}

function stopDeviceMotion(){ 
    window.removeEventListener("devicemotion", handleAcceleration, false);
}


////////////////////////////////////////////////////////////////////
//Function(1): èª­ã¿è¾¼ã¾ã‚Œã¦ããŸæœ€æ–°ã®åŠ é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿(X,Y,Z)ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
//  - ã“ã®é–¢æ•°ã¯(æ©Ÿç¨®ã«ã‚ˆã‚Šã¾ã™ãŒ) ç§’é€Ÿ10ã€œ100å›ã¨ã„ã†ã‚ˆã†ãªé«˜é »åº¦ã§å‘¼ã°ã‚Œã¾ã™
////////////////////////////////////////////////////////////////////
function handleAcceleration(ev){

    //alert("" + event.acceleration.x + " " + event.acceleration.y + " " + event.acceleration.z);
    $('#accel-x').text( ev.acceleration.x );
    xdata.push(ev.acceleration.x);
    $('#accel-y').text( ev.acceleration.y );
    ydata.push(ev.acceleration.y);
    $('#accel-z').text( ev.acceleration.z );
    zdata.push(ev.acceleration.z);
    $('#raw-data').append(ev.acceleration.x + ", " + ev.acceleration.y + ", " + ev.acceleration.z + "\n");

    // Save data with label and timestamp
    var timestamp = new Date().getTime();
    collectedData.push({
        timestamp: timestamp,
        x: ev.acceleration.x,
        y: ev.acceleration.y,
        z: ev.acceleration.z,
        label: currentLabel
    });
    $('#data_count').text(collectedData.length);

    num_data++;
    //If we have enough raw sensor data...
    if( num_data == NUM_DATA_PER_FRAME ){

	//execute feature calculations.
	featureExtraction();

	//Let's classify the activity!
	var current_activity = classify();
	$('#current_result').text( current_activity );
	
	//clear the raw sensor data
	xdata=[];
	ydata=[];
	zdata=[];
	//Clear the textarea 
	$('#raw-data').empty();
	//Counter back to 0
	num_data=0;
    }
    
}

////////////////////////////////////////////////////////////////////
//Function(2):ã‚»ãƒ³ã‚µãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ "feature"(ç‰¹å¾´é‡)ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
//  - ã“ã®é–¢æ•°ã¯ NUM_DATA_PER_FRAME å¤‰æ•°ã§è¨­å®šã•ã‚ŒãŸæ•°ã ã‘ã‚»ãƒ³ã‚µãƒ‡ãƒ¼ã‚¿ãŒ
//    ã€Œè¨­å®šã•ã‚ŒãŸã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ ã€ã«ãŸã¾ã‚‹åº¦ã«å‘¼ã°ã‚Œã¾ã™ã€‚
//  - ä¾‹: ã‚»ãƒ³ã‚µãƒ‡ãƒ¼ã‚¿ãŒ 50Hz (=50 data / seconds)
//        NUM_DATA_PER_FRAME ãŒ 200 ã®å ´åˆ
//        â†’ ç´„4ç§’ã«1åº¦ã®é »åº¦ã§å‘¼ã°ã‚Œã¾ã™
////////////////////////////////////////////////////////////////////
//helper func. to calculate average
const arrAvg = arr => arr.reduce((a,b) => a + b, 0) / arr.length

function featureExtraction(){
    xmin = Math.min.apply(Math, xdata); $('#xmin').text(xmin);
    xmax = Math.max.apply(Math, xdata); $('#xmax').text(xmax);
    xave = arrAvg(xdata); $('#xave').text(xave);
    
    ymin = Math.min.apply(Math, ydata); $('#ymin').text(ymin);
    ymax = Math.max.apply(Math, ydata); $('#ymax').text(ymax);
    yave = arrAvg(ydata); $('#yave').text(yave);

    zmax = Math.max.apply(Math, zdata); $('#zmax').text(zmax);
    zmin = Math.min.apply(Math, zdata); $('#zmin').text(zmin);
    zave = arrAvg(zdata); $('#zave').text(zave);
}

////////////////////////////////////////////////////////////////////
//Function(3): æœ€æ–°ãƒ•ãƒ¬ãƒ¼ãƒ ã«ãŠã‘ã‚‹ç‰¹å¾´é‡(feature)ã‹ã‚‰ã€ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ã®
//è¡Œå‹•ã‚’åˆ†é¡ (classify) ã™ã‚‹é–¢æ•°          
//  - ã“ã“ã«æ›¸ã„ã¦ã‚ã‚‹ã®ã¯ã€æ‰‹æ‰“ã¡ã§æ›¸ã„ãŸã‚µãƒ³ãƒ—ãƒ«ã®ifæ–‡ãƒ­ã‚¸ãƒƒã‚¯ã§ã™
//  - å®Ÿéš›ã«ã¯æ©Ÿæ¢°å­¦ç¿’ã‚¨ãƒ³ã‚¸ãƒ³ãŒå‡ºåŠ›ã—ãŸifæ–‡ã®å›ºã¾ã‚Š (æ±ºå®šæœ¨ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®å ´åˆ)
//  - ãŒã“ã“ã«å…¥ã‚Šã¾ã™
////////////////////////////////////////////////////////////////////
function classify(){

    if(xmax > 1){
	return 'walking';
    }else{
	return 'still';
    }

    /*
    if(zmin <= 0.1){
	if(xmin <= -0.2){
	    if(xmin <= -0.4){
		return 'walking';
	    }else{
		return 'still';
	    }
	}else{
	    return 'walking';
	}
    }else{
	return 'still';
    }
    */

}

////////////////////////////////////////////////////////////////////
//Data Collection Functions / ãƒ‡ãƒ¼ã‚¿åé›†ç”¨ã®é–¢æ•°
////////////////////////////////////////////////////////////////////

// Set the current activity label
function setLabel(label){
    currentLabel = label;
    $('#current_label').text(label);
    alert('Label set to: ' + label + ' / ãƒ©ãƒ™ãƒ«ã‚’è¨­å®šã—ã¾ã—ãŸ: ' + label);
}

// Download collected data as CSV
function downloadCSV(){
    if(collectedData.length === 0){
        alert('No data to download! / ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼');
        return;
    }
    
    // Create CSV header
    var csv = 'timestamp,x,y,z,label\n';
    
    // Add data rows
    for(var i = 0; i < collectedData.length; i++){
        var row = collectedData[i];
        csv += row.timestamp + ',' + 
               row.x + ',' + 
               row.y + ',' + 
               row.z + ',' + 
               row.label + '\n';
    }
    
    // Create download link
    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    var link = document.createElement('a');
    var url = URL.createObjectURL(blob);
    
    // Generate filename with timestamp
    var now = new Date();
    var filename = 'activity_data_' + 
                   now.getFullYear() + 
                   ('0' + (now.getMonth() + 1)).slice(-2) + 
                   ('0' + now.getDate()).slice(-2) + '_' +
                   ('0' + now.getHours()).slice(-2) + 
                   ('0' + now.getMinutes()).slice(-2) + 
                   ('0' + now.getSeconds()).slice(-2) + 
                   '.csv';
    
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert('Downloaded ' + collectedData.length + ' data points as ' + filename + 
          ' / ' + collectedData.length + ' å€‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ ' + filename + ' ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
}

// Clear all collected data
function clearCollectedData(){
    if(confirm('Are you sure you want to clear all collected data? / åé›†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')){
        collectedData = [];
        $('#data_count').text('0');
        alert('All data cleared! / å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼');
    }
}

////////////////////////////////////////////////////////////////////
//2-Minute Timer Functions / 2åˆ†é–“ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ï¼ˆ3ç§’æº–å‚™ + 120ç§’åé›†ï¼‰
////////////////////////////////////////////////////////////////////

// Start 2-minute data collection with 3-second preparation
function start30SecondCollection(){
    // Check if label is set
    if(currentLabel === 'none'){
        alert('Please select an activity label first! / å…ˆã«è¡Œå‹•ãƒ©ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼');
        return;
    }
    
    // Check if already collecting
    if(isCollecting){
        alert('Collection already in progress! / æ—¢ã«åé›†ä¸­ã§ã™ï¼');
        return;
    }
    
    alert('3ç§’å¾Œã«ãƒ‡ãƒ¼ã‚¿åé›†ã‚’é–‹å§‹ã—ã¾ã™ï¼ã‚¹ãƒãƒ›ã‚’ãƒã‚±ãƒƒãƒˆã«å…¥ã‚Œã¦ãã ã•ã„ã€‚\n\nData collection will start in 3 seconds! Put your phone in your pocket.');
    
    // Start timer immediately (will show 3-second preparation)
    startTimer();
    
    // Start motion sensing after 3 seconds
    setTimeout(function(){
        if ( DeviceMotionEvent &&
             typeof DeviceMotionEvent.requestPermission === 'function' ){
            // iOS 13+ ã® Safari
            DeviceMotionEvent.requestPermission().then(permissionState => {
                if (permissionState === 'granted') {
                    window.addEventListener("devicemotion", handleAcceleration, false);
                } else {
                    alert("Permission not granted! / è¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼");
                    stopTimer();
                }
            }).catch(function(error){
                console.error(error);
                stopTimer();
            });
        } else {
            // For other devices
            window.addEventListener("devicemotion", handleAcceleration, false);
        }
    }, 3000); // Wait 3 seconds before starting sensor
}

// Start the timer
function startTimer(){
    isCollecting = true;
    remainingTime = 123; // 3 seconds preparation + 120 seconds collection
    
    // Show "æº–å‚™ä¸­" initially
    $('#status_display').text('æº–å‚™ä¸­ / Preparing').css('color', 'orange');
    $('#timer_display').text('3').css('color', 'orange');
    
    // Beep sound at start
    if (window.AudioContext || window.webkitAudioContext) {
        playBeep(440, 200); // 440Hz for 200ms
    }
    
    // Update timer every second
    timerInterval = setInterval(function(){
        remainingTime--;
        
        // First 3 seconds: Preparation phase
        if(remainingTime > 120){
            var prepTime = remainingTime - 120;
            $('#timer_display').text(prepTime).css('color', 'orange');
            $('#status_display').text('æº–å‚™ä¸­ / Preparing').css('color', 'orange');
            
            // Beep during preparation countdown
            if (window.AudioContext || window.webkitAudioContext) {
                playBeep(660, 100);
            }
        }
        // Collection phase (120 seconds)
        else if(remainingTime === 120){
            // Start of data collection
            $('#status_display').text('åé›†ä¸­ / Collecting').css('color', 'green');
            $('#timer_display').text(remainingTime).css('color', 'red');
            
            // Double beep to signal start of actual collection
            if (window.AudioContext || window.webkitAudioContext) {
                playBeep(880, 150);
                setTimeout(function(){ playBeep(880, 150); }, 200);
            }
        }
        else if(remainingTime > 0){
            // Normal collection countdown
            $('#timer_display').text(remainingTime).css('color', 'red');
            
            // Beep at 60, 30, 10, 5, 3, 2, 1 seconds remaining
            if(remainingTime === 60 || remainingTime === 30 || remainingTime === 10 || 
               remainingTime === 5 || (remainingTime <= 3 && remainingTime > 0)){
                if (window.AudioContext || window.webkitAudioContext) {
                    playBeep(880, 100); // Higher pitch beep
                }
            }
        }
        else{
            // Time is up
            stopTimer();
        }
    }, 1000);
}

// Stop the timer and collection
function stopTimer(){
    if(timerInterval){
        clearInterval(timerInterval);
        timerInterval = null;
    }
    
    isCollecting = false;
    remainingTime = 0;
    $('#timer_display').text('--').css('color', 'red');
    $('#status_display').text('å®Œäº† / Completed').css('color', 'blue');
    
    // Stop motion sensing
    window.removeEventListener("devicemotion", handleAcceleration, false);
    
    // Final beep (lower pitch, longer duration)
    if (window.AudioContext || window.webkitAudioContext) {
        playBeep(220, 500);
    }
    
    alert('2åˆ†é–“ã®ãƒ‡ãƒ¼ã‚¿åé›†ãŒå®Œäº†ã—ã¾ã—ãŸï¼/ 2-minute collection completed!\n\nåé›†ãƒ‡ãƒ¼ã‚¿æ•° / Data points: ' + collectedData.length);
}

// Play beep sound
function playBeep(frequency, duration){
    try {
        var audioContext = new (window.AudioContext || window.webkitAudioContext)();
        var oscillator = audioContext.createOscillator();
        var gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration/1000);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration/1000);
    } catch(e) {
        console.log('Audio not supported:', e);
    }
}

</script>
<!--  ===========================================  -->


</html>
