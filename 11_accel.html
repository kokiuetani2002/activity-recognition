<html>

  <head>
    <title>jQuery Mobile page</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="stylesheet" href="https://web.sfc.keio.ac.jp/~slash/ABC/ac/themes/TOBASIC.css" />
    <link rel="stylesheet" href="https://web.sfc.keio.ac.jp/~slash/ABC/ac/themes/jquery.mobile.icons.min.css" />

    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script> 
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile.structure-1.4.5.min.css" /> 
  </head>
  
  <body>
    <div style="align: center;">
      <button onclick="requestMotionPermission();">Get permission and start sensing</button>
      <button onclick="stopDeviceMotion();">Stop</button>
    </div>
    
    <h2>Data Collection</h2>
    <div style="background-color: #f0f0f0; padding: 15px; margin: 10px 0;">
      <h3>Select Activity Label / 行動ラベルを選択</h3>
      <div style="margin: 10px 0;">
        <button onclick="setLabel('still')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #e3f2fd;">Still / 静止</button>
        <button onclick="setLabel('tuugaku_walk')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #fff3e0;">通学歩き</button>
        <button onclick="setLabel('sanpo')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #e8f5e9;">散歩</button>
        <button onclick="setLabel('yotsunbai')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #fce4ec;">四足歩行</button>
        <button onclick="setLabel('heel_walk')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #f3e5f5;">ヒール歩き</button>
        <button onclick="setLabel('sandal_walk')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #ffccbc;">サンダル歩き</button>
        <button onclick="setLabel('stairs')" style="padding: 10px 20px; margin: 5px; font-size: 1.2em; background-color: #ffe0b2;">階段</button>
      </div>
      <p>Current Label / 現在のラベル: <span id="current_label" style="color: blue; font-weight: bold; font-size: 1.5em;">none</span></p>
      
      <div style="margin: 15px 0; padding: 10px; background-color: #fff9c4; border-radius: 5px;">
        <h3>30秒タイマー機能 / 30-Second Timer</h3>
        <button onclick="start30SecondCollection()" style="padding: 15px 30px; margin: 10px; font-size: 1.3em; background-color: #2196F3; color: white; border: none; cursor: pointer;">⏱️ 30秒間データ収集 / Collect for 30s</button>
        <p>残り時間 / Time Remaining: <span id="timer_display" style="color: red; font-weight: bold; font-size: 2.0em;">--</span> 秒</p>
      </div>
      
      <p>Collected Data Points / 収集データ数: <span id="data_count" style="color: green; font-weight: bold; font-size: 1.5em;">0</span></p>
      <button onclick="downloadCSV()" style="padding: 15px 30px; margin: 10px; font-size: 1.3em; background-color: #4CAF50; color: white; border: none; cursor: pointer;">Download CSV / CSVダウンロード</button>
      <button onclick="clearCollectedData()" style="padding: 15px 30px; margin: 10px; font-size: 1.3em; background-color: #f44336; color: white; border: none; cursor: pointer;">Clear Data / データクリア</button>
    </div>
    
    <h2>Activity Recognition</h2>
    <h3>(3) Classification result</h3>
    <ul>
    <li> Result: <span id="current_result" style="color:red;font-size:2.0em; font-weight: bold; border-top: 1px solid black; border-bottom: 1px solid black;">null</span> </li> 
    </ul>
    
    <h3>(2) Features for this time window</h3>
    <ul>
    <li> min x: <span id="xmin">0</span> </li>
    <li> max x: <span id="xmax">0</span> </li>
    <li> ave x: <span id="xave">0</span> </li>

    <li> min y: <span id="ymin">0</span> </li>
    <li> max y: <span id="ymax">0</span> </li>
    <li> ave y: <span id="yave">0</span> </li>

    <li> min z: <span id="zmin">0</span> </li>
    <li> max z: <span id="zmax">0</span> </li>
    <li> ave z: <span id="zave">0</span> </li>
    </ul>

    <h3>(1) Raw sensor values for this time window</h3>
    <ul>
    <li> X: <span id="accel-x">0</span> </li> 
    <li> Y: <span id="accel-y">0</span> </li> 
    <li> Z: <span id="accel-z">0</span> </li>
    </ul>
    
    <textarea id="raw-data" style="width:90%;height:50vh;"></textarea>

    <hr/>

    <h2>レポート記述欄 / Report</h2>
    <ul>
      <li>Name / 氏名:</li>
      <li>Department / 学部:</li>
      <li>Year / 学年:</li>
      <li>Student ID / 学籍番号:</li>
      <li>CNS Email / CNSメールアドレス:</li>
    </ul>

    <h3>Collected Data / 収集した行動データ</h3>
    <ul>
      <li>Reason behind data selection / 選定した理由</li>
      <li>Details about collection / 収集についての詳細</li>
      <li>Any challenges and tweaks / 工夫した点・困難だった点</li>
    </ul>

    <h3>Features / 特徴量</h3>
    <ul>
      <li>Reason behind data selection / 選定した理由</li>
      <li>Details about additional feature types / 追加した特徴量について</li>
      <li>Any challenges and tweaks / 工夫した点・困難だった点</li>
    </ul>    

    <h3>ML Model / 機械学習モデル</h3>
    <ul>
      <li>Algorithm you used and the training result / 採用したアルゴリズムや学習結果の詳細</li>
      <li>Any challenges and tweaks / 工夫した点・困難だった点</li>
    </ul>

    <h3>Real-time execution result / 実機に移植しての性能評価</h3>
    <ul>
      <li>Evaluation metric you used / 評価尺度について</li>
      <li>Evaluation results / 評価結果</li>
      <li>Any challenges and tweaks / 工夫した点・困難だった点</li>
    </ul>

  </body>


<!--  ===========================================  -->
<script type="text/javascript">

alert("Welcome to example Activity Recognition (11).");

//CONFIG: Length of each time window
const NUM_DATA_PER_FRAME = 200;

//Arrays for saving the raw sensor data
var xdata = [];
var ydata = [];
var zdata = [];
var num_data = 0;

//Features
var xmin = 0.0;
var xmax = 0.0;
var xave = 0.0;
var ymin = 0.0;
var ymax = 0.0;
var yave = 0.0;
var zmin = 0.0;
var zmax = 0.0;
var zave = 0.0;

//Data collection variables
var collectedData = []; // Array to store all collected data with labels
var currentLabel = 'none'; // Current activity label

//Timer variables
var timerInterval = null; // Timer interval ID
var remainingTime = 0; // Remaining time in seconds
var isCollecting = false; // Flag to track if collection is active

//////////////////////////////////////////////////////
//Function to get sensor access permission from the browser
//////////////////////////////////////////////////////
function requestMotionPermission(){
  if ( DeviceMotionEvent &&
       typeof DeviceMotionEvent.requestPermission === 'function' ){
      // iOS 13+ の Safari
      // 許可を取得
      DeviceMotionEvent.requestPermission().then(permissionState => {
	  if (permissionState === 'granted') {
              // 許可を得られた場合、devicemotionをイベントリスナーに追加
	      window.addEventListener("devicemotion", handleAcceleration, false);
	  } else {
              // 許可を得られなかった場合の処理
	      console.log("Perrmission not granted!");
	      alert("Perrmission not granted!");
	  }
      }).catch(console.error) // https通信でない場合などで許可を取得できなかった場合

  } else {
      //For other devices
      console.log("detected other device. so adding listener...");
      window.addEventListener("devicemotion", handleAcceleration, false);
  }

}

function stopDeviceMotion(){ 
    window.removeEventListener("devicemotion", handleAcceleration, false);
}


////////////////////////////////////////////////////////////////////
//Function(1): 読み込まれてきた最新の加速度データ(X,Y,Z)を処理する関数
//  - この関数は(機種によりますが) 秒速10〜100回というような高頻度で呼ばれます
////////////////////////////////////////////////////////////////////
function handleAcceleration(ev){

    //alert("" + event.acceleration.x + " " + event.acceleration.y + " " + event.acceleration.z);
    $('#accel-x').text( ev.acceleration.x );
    xdata.push(ev.acceleration.x);
    $('#accel-y').text( ev.acceleration.y );
    ydata.push(ev.acceleration.y);
    $('#accel-z').text( ev.acceleration.z );
    zdata.push(ev.acceleration.z);
    $('#raw-data').append(ev.acceleration.x + ", " + ev.acceleration.y + ", " + ev.acceleration.z + "\n");

    // Save data with label and timestamp
    var timestamp = new Date().getTime();
    collectedData.push({
        timestamp: timestamp,
        x: ev.acceleration.x,
        y: ev.acceleration.y,
        z: ev.acceleration.z,
        label: currentLabel
    });
    $('#data_count').text(collectedData.length);

    num_data++;
    //If we have enough raw sensor data...
    if( num_data == NUM_DATA_PER_FRAME ){

	//execute feature calculations.
	featureExtraction();

	//Let's classify the activity!
	var current_activity = classify();
	$('#current_result').text( current_activity );
	
	//clear the raw sensor data
	xdata=[];
	ydata=[];
	zdata=[];
	//Clear the textarea 
	$('#raw-data').empty();
	//Counter back to 0
	num_data=0;
    }
    
}

////////////////////////////////////////////////////////////////////
//Function(2):センサデータから "feature"(特徴量)を計算する関数
//  - この関数は NUM_DATA_PER_FRAME 変数で設定された数だけセンサデータが
//    「設定されたタイムフレーム」にたまる度に呼ばれます。
//  - 例: センサデータが 50Hz (=50 data / seconds)
//        NUM_DATA_PER_FRAME が 200 の場合
//        → 約4秒に1度の頻度で呼ばれます
////////////////////////////////////////////////////////////////////
//helper func. to calculate average
const arrAvg = arr => arr.reduce((a,b) => a + b, 0) / arr.length

function featureExtraction(){
    xmin = Math.min.apply(Math, xdata); $('#xmin').text(xmin);
    xmax = Math.max.apply(Math, xdata); $('#xmax').text(xmax);
    xave = arrAvg(xdata); $('#xave').text(xave);
    
    ymin = Math.min.apply(Math, ydata); $('#ymin').text(ymin);
    ymax = Math.max.apply(Math, ydata); $('#ymax').text(ymax);
    yave = arrAvg(ydata); $('#yave').text(yave);

    zmax = Math.max.apply(Math, zdata); $('#zmax').text(zmax);
    zmin = Math.min.apply(Math, zdata); $('#zmin').text(zmin);
    zave = arrAvg(zdata); $('#zave').text(zave);
}

////////////////////////////////////////////////////////////////////
//Function(3): 最新フレームにおける特徴量(feature)から、現在のユーザの
//行動を分類 (classify) する関数          
//  - ここに書いてあるのは、手打ちで書いたサンプルのif文ロジックです
//  - 実際には機械学習エンジンが出力したif文の固まり (決定木アルゴリズムの場合)
//  - がここに入ります
////////////////////////////////////////////////////////////////////
function classify(){

    if(xmax > 1){
	return 'walking';
    }else{
	return 'still';
    }

    /*
    if(zmin <= 0.1){
	if(xmin <= -0.2){
	    if(xmin <= -0.4){
		return 'walking';
	    }else{
		return 'still';
	    }
	}else{
	    return 'walking';
	}
    }else{
	return 'still';
    }
    */

}

////////////////////////////////////////////////////////////////////
//Data Collection Functions / データ収集用の関数
////////////////////////////////////////////////////////////////////

// Set the current activity label
function setLabel(label){
    currentLabel = label;
    $('#current_label').text(label);
    alert('Label set to: ' + label + ' / ラベルを設定しました: ' + label);
}

// Download collected data as CSV
function downloadCSV(){
    if(collectedData.length === 0){
        alert('No data to download! / ダウンロードするデータがありません！');
        return;
    }
    
    // Create CSV header
    var csv = 'timestamp,x,y,z,label\n';
    
    // Add data rows
    for(var i = 0; i < collectedData.length; i++){
        var row = collectedData[i];
        csv += row.timestamp + ',' + 
               row.x + ',' + 
               row.y + ',' + 
               row.z + ',' + 
               row.label + '\n';
    }
    
    // Create download link
    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    var link = document.createElement('a');
    var url = URL.createObjectURL(blob);
    
    // Generate filename with timestamp
    var now = new Date();
    var filename = 'activity_data_' + 
                   now.getFullYear() + 
                   ('0' + (now.getMonth() + 1)).slice(-2) + 
                   ('0' + now.getDate()).slice(-2) + '_' +
                   ('0' + now.getHours()).slice(-2) + 
                   ('0' + now.getMinutes()).slice(-2) + 
                   ('0' + now.getSeconds()).slice(-2) + 
                   '.csv';
    
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert('Downloaded ' + collectedData.length + ' data points as ' + filename + 
          ' / ' + collectedData.length + ' 個のデータを ' + filename + ' としてダウンロードしました');
}

// Clear all collected data
function clearCollectedData(){
    if(confirm('Are you sure you want to clear all collected data? / 収集したデータを全てクリアしますか？')){
        collectedData = [];
        $('#data_count').text('0');
        alert('All data cleared! / 全てのデータをクリアしました！');
    }
}

////////////////////////////////////////////////////////////////////
//30-Second Timer Functions / 30秒タイマー機能
////////////////////////////////////////////////////////////////////

// Start 30-second data collection
function start30SecondCollection(){
    // Check if label is set
    if(currentLabel === 'none'){
        alert('Please select an activity label first! / 先に行動ラベルを選択してください！');
        return;
    }
    
    // Check if already collecting
    if(isCollecting){
        alert('Collection already in progress! / 既に収集中です！');
        return;
    }
    
    // Start motion sensing if not already started
    if ( DeviceMotionEvent &&
         typeof DeviceMotionEvent.requestPermission === 'function' ){
        // iOS 13+ の Safari
        DeviceMotionEvent.requestPermission().then(permissionState => {
            if (permissionState === 'granted') {
                window.addEventListener("devicemotion", handleAcceleration, false);
                startTimer();
            } else {
                alert("Permission not granted! / 許可されませんでした！");
            }
        }).catch(console.error)
    } else {
        // For other devices
        window.addEventListener("devicemotion", handleAcceleration, false);
        startTimer();
    }
}

// Start the timer
function startTimer(){
    isCollecting = true;
    remainingTime = 30;
    $('#timer_display').text(remainingTime);
    
    // Beep sound at start
    if (window.AudioContext || window.webkitAudioContext) {
        playBeep(440, 200); // 440Hz for 200ms
    }
    
    alert('30秒間のデータ収集を開始します！/ Starting 30-second collection!');
    
    // Update timer every second
    timerInterval = setInterval(function(){
        remainingTime--;
        $('#timer_display').text(remainingTime);
        
        // When time is up
        if(remainingTime <= 0){
            stopTimer();
        }
        
        // Beep at 10, 5, 3, 2, 1 seconds remaining
        if(remainingTime === 10 || remainingTime === 5 || remainingTime <= 3 && remainingTime > 0){
            if (window.AudioContext || window.webkitAudioContext) {
                playBeep(880, 100); // Higher pitch beep
            }
        }
    }, 1000);
}

// Stop the timer and collection
function stopTimer(){
    if(timerInterval){
        clearInterval(timerInterval);
        timerInterval = null;
    }
    
    isCollecting = false;
    remainingTime = 0;
    $('#timer_display').text('--');
    
    // Stop motion sensing
    window.removeEventListener("devicemotion", handleAcceleration, false);
    
    // Final beep (lower pitch, longer duration)
    if (window.AudioContext || window.webkitAudioContext) {
        playBeep(220, 500);
    }
    
    alert('30秒間のデータ収集が完了しました！/ 30-second collection completed!\n\n収集データ数 / Data points: ' + collectedData.length);
}

// Play beep sound
function playBeep(frequency, duration){
    try {
        var audioContext = new (window.AudioContext || window.webkitAudioContext)();
        var oscillator = audioContext.createOscillator();
        var gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration/1000);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration/1000);
    } catch(e) {
        console.log('Audio not supported:', e);
    }
}

</script>
<!--  ===========================================  -->


</html>
